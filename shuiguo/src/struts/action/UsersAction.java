/*
 * Generated by MyEclipse Struts
 * Template path: templates/java/JavaClass.vtl
 */
package struts.action;

import java.io.IOException;
import java.io.PrintWriter;

import javax.persistence.Entity;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.apache.struts.action.ActionForm;
import org.apache.struts.action.ActionForward;
import org.apache.struts.action.ActionMapping;
import org.apache.struts.actions.DispatchAction;

import bean.PublicBean;

import server.UserServer;
import server.impl.UserServerImpl;
import struts.form.UsersForm;
import entity.Users;

/**
 * MyEclipse Struts Creation date: 06-23-2010
 * 
 * XDoclet definition:
 * 
 * @struts.action path="/users" name="usersForm" parameter="method"
 *                scope="request"
 */
@Entity public class UsersAction extends DispatchAction {
	/*
	 * Generated Methods
	 */

	/**
	 * Method execute
	 * 
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return ActionForward
	 * @throws IOException
	 */
	public ActionForward usersLogin(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response)
			throws IOException {
		UsersForm usersForm = (UsersForm) form;
		UserServer server = new UserServerImpl();

		Users users = server.login(usersForm.getUname(), usersForm.getUpwd());
		if (users == null) {

			response.getWriter().print("<script>");
			response.getWriter().print("alert('用户名或密码不正确！');");
			response.getWriter().print("window.history.go(-1);");
			response.getWriter().print("</script>");
			return null;

		}

		request.getSession().setAttribute("users", users);

		if (usersForm.getFromto() != null
				&& usersForm.getFromto().equals("index")) {
			return mapping.findForward("index");
		} else {
			return mapping.findForward("usok");
		}

	}

	public ActionForward addUsers(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response)
			throws IOException {
		request.setCharacterEncoding("UTF-8");
		response.setCharacterEncoding("UTF-8");
		UsersForm usersForm = (UsersForm) form;
		UserServer server=new UserServerImpl();
		
		PrintWriter out = response.getWriter();
		boolean flag = false;
		String uname = usersForm.getUname();
		String upwd = usersForm.getUpwd();
		String qr_pwd = usersForm.getUpwd();
		String email = usersForm.getEmail();
		String phone = usersForm.getPhone();
				
		UserServer userServer = new UserServerImpl();
		Users users = new Users();
		users.setUname(uname);
		users.setUpwd(qr_pwd);
		users.setEmail(email);
		users.setPhone(phone);

		flag = userServer.add(users);
		if (flag == true) {

			out.print("<script>");
			out.print("alert('注册成功!!!');");
			out.print("window.location='userLogin.jsp';");

			out.print("</script>");
			return null;
		} else {

			out.print("<script>");
			out.print("alert('注册失败!!!');");
			out.print("window.history.go(-1);");
			out.print("</script>");
			return null;

		}

	}

	public ActionForward delUsers(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response)
			throws IOException {
		UsersForm usersForm = (UsersForm) form;
		UserServer server=new UserServerImpl();
		
		PrintWriter out = response.getWriter();
		int uid =usersForm.getUid();
		boolean flag = server.delete(uid);
		if(flag){
			out.print("<script>");
			out.print("alert('删除成功!!!');");
			out.print("window.location='users.do?method=showUsers&showPage=1';");
			out.print("</script>");
			return null;
		}else{
			out.print("<script>");
			out.print("alert('删除失败!!!');");
			out.print("window.history.go(-1);");
			out.print("</script>");
			return null;
		}
	}
	// 查看用户(分页查询)
	public ActionForward showUsers(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response)
			throws IOException {
		UsersForm usersForm = (UsersForm) form;
        UserServer server=new UserServerImpl();
		
		int showPage=usersForm.getShowPage();  //获得所要显示的页码
		
		String uname=usersForm.getUname();
		
		PublicBean bean=server.selectByPage(showPage, uname);
		
		request.setAttribute("ulist", bean.getList());
		request.setAttribute("allCount", bean.getAllCount());
		request.setAttribute("allPage", bean.getAllPage());
		request.setAttribute("showPage", showPage);
		return mapping.findForward("show");

	}

	// 获得用户信息
	public ActionForward getUser(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response)
			throws IOException {
		UsersForm usersForm = (UsersForm) form;
        UserServer server=new UserServerImpl();
		
        int uid=usersForm.getUid();  //获得用户id
		Users user=server.getUser(uid); //加载用户
		request.setAttribute("user", user);
		return mapping.findForward("showinfo");

	}	
	// 退出
	public ActionForward logout(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response)
			throws IOException {
		UsersForm usersForm = (UsersForm) form;
		request.getSession().setAttribute("users", null);
		if (usersForm.getFromto().equals("user")) {
			return mapping.findForward("login");
		} else {
			return mapping.findForward("index");
		}

	}

	// 修改密码
	public ActionForward updatePwd(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response)
			throws IOException {
		UsersForm usersForm = (UsersForm) form;
		PrintWriter out = response.getWriter();
		boolean flag = false;

		String newpwd = request.getParameter("newpwd");

		UserServer userServer = new UserServerImpl();

		Users users = (Users) request.getSession().getAttribute("users");

		users.setUpwd(newpwd);

		flag = userServer.update(users);
		if (flag == true) {
			out.print("<script>");
			out.print("alert('修改成功!!!');");
			out.print("window.location='update_pwd.jsp';");
			out.print("</script>");
			return null;
		} else {

			out.print("<script>");
			out.print("alert('修改失败!!!');");
			out.print("window.history.go(-1);");
			out.print("</script>");
			return null;

		}

	}
}
